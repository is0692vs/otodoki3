name: Jules Trigger

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  jules-trigger:
    runs-on: ubuntu-slim
    permissions:
      issues: write
    if: github.event.issue.user.login == 'is0692vs'
    steps:
      - name: Check for @Jules mention and trigger Jules
        uses: actions/github-script@v8
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const JULES_SUCCESS_COMMENT = 'ü§ñ **Jules AI Agent „ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü**';
            const issueNumber = context.payload.issue.number;

            // Fetch the full issue to avoid a truncated body from the event payload
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const issueBody = issue.body || '';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const hasJulesComment = comments.some(comment => comment.body.includes(JULES_SUCCESS_COMMENT));
            if (hasJulesComment) {
              console.log('Jules has already been triggered for this issue.');
              return;
            }

            const allCommentsText = comments.map(comment => comment.body).join('\\n');
            const combinedText = issueBody + '\\n' + allCommentsText;

            if (combinedText.toLowerCase().includes('@jules')) {
              // Clean the issue body
              const cleanedIssueBody = issueBody.replace(/@jules\s*/i, '').trim();

              let prompt = `Issue Title: ${issue.title}\\n\\nIssue Body:\\n${cleanedIssueBody}\\n\\n`;
              if (comments.length > 0) {
                prompt += 'Comments:\\n';
                for (const comment of comments) {
                  prompt += `- ${comment.body}\\n`;
                }
              }

              // Add default instructions
              const issueUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}`;
              prompt += `\\n\\nInstructions:\\n- Include the issue URL: ${issueUrl}\\n- In the PR description, include that it was created from this issue.\\n- Write the PR description in Japanese and make it detailed.`;
              prompt += `\n\nInstructions:\n- Include the issue URL: ${issueUrl}\n- In the PR description, include that it was created from this issue.\n- Write the PR description in Japanese and make it detailed.`;
              try {
                const response = await fetch('https://jules.googleapis.com/v1alpha/sessions', {
                  method: 'POST',
                  headers: {
                    'X-Goog-Api-Key': process.env.JULES_API_KEY, 
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    prompt: prompt,
                    sourceContext: {
                      source: `sources/github/${context.repo.owner}/${context.repo.repo}`,
                      githubRepoContext: {
                        startingBranch: context.payload.repository.default_branch
                      }
                    },
                    automationMode: 'AUTO_CREATE_PR',
                    title: `Issue #${issue.number}: ${issue.title}`
                  })
                });

                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`Jules API error: ${response.status} - ${errorText}`);
                }

                const session = await response.json();

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `${JULES_SUCCESS_COMMENT}\n\n„Çª„ÉÉ„Ç∑„Éß„É≥URL: ${session.url}\n\nJules„Åå„Åì„ÅÆIssue„Å´Âü∫„Å•„ÅÑ„Å¶„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„ÅóÔºåPR„ÇíËá™Âãï‰ΩúÊàê„Åó„Åæ„ÅôÔºé`
                });
              } catch (error) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `‚ùå **JulesËµ∑Âãï„Ç®„É©„Éº**\n\n\`\`\`json\n${error.message}\n\`\`\``
                });
                throw error;
              }
            }
